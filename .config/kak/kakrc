evaluate-commands %sh{echo source $HOME/.config/kak/kak/modules.kak}

import utils
import global
import diff
import macros
import fzf

# Plugs

source "%val{config}/plugins/plug.kak/rc/plug.kak"
plug andreyorst/plug.kak branch kakoune-git noload

plug occivink/kakoune-gdb
plug TeddyDD/kakoune-cfdg
#plug TeddyDD/kakoune-wiki
#plug lenormf/kakoune-extra
plug TeddyDD/kakoune-edit-or-dir
plug occivink/kakoune-snippets config %{
    set-option -add global snippets_directories "%opt{plug_install_dir}/kakoune-snippet-collection/snippets"
    set global snippets_auto_expand false
}
plug andreyorst/kakoune-snippet-collection
plug alexherbo2/select.kak
plug alexherbo2/auto-pairs.kak config %{
  hook global WinCreate .* %{
    auto-pairs-enable
  }
  map global user s -docstring 'Surround' ': auto-pairs-surround <lt> <gt><ret>'
  map global user S -docstring 'Surround++' ': auto-pairs-surround <lt> <gt> _ _ * *<ret>'
}
plug alexherbo2/phantom.kak config %{
  hook global WinCreate .* %{
    phantom-enable -with-maps
  }
}
plug alexherbo2/connect.kak

plug "git@gitlab.com:topisani/kaktree.git" defer kaktree %{
    set-option global kaktree_dir_icon_close  '▸  '
    set-option global kaktree_dir_icon_open   '▾  '
    set-option global kaktree_file_icon       '⠀⠀ '
                                            # ^^ these are not spaces. It is invisible characters.
                                            # This needed to make folding work correctly if you do
                                            # space alignment of icons.
} config %{
    map global user '<tab>' ": kaktree-toggle<ret>" -docstring "toggle filetree panel"
    hook global WinSetOption filetype=kaktree %{
        remove-highlighter window/numbers
        remove-highlighter window/matching
        remove-highlighter window/wrap
        remove-highlighter window/show-whitespaces
        set buffer modelinefmt ""
    }
    kaktree-enable
}

plug andreyorst/powerline.kak defer "powerline" %{
  set-option global powerline_format 'powerline-format git bufname filetype mode_info lsp-errors line_column position'
  powerline-theme flatblue
}

plug occivink/kakoune-find config %{
  define-command -docstring "grep-apply-changes: apply changes specified in current *grep* buffer to their respective files" \
  grep-apply-changes %{ find-apply-changes -force }
}

# use :pad-number to pad numbers with zeros
plug alexherbo2/pad-number.kak
plug alexherbo2/yank-ring.kak config %{
  map global normal Y ': yank-ring<ret>'
}

plug alexherbo2/mkdir.kak config %{
  hook global BufWritePre .* %{
  	mkdir-buffer
  }
}

plug alexherbo2/distraction-free.kak config %{
	map global user d ': distraction-free-toggle<ret>' -docstring "Case manipulation..."
}
plug alexherbo2/search-highlighter.kak config %{
  hook global WinCreate .* %{
    search-highlighter-enable
  }
}

plug alexherbo2/bc.kak config %{
  map global normal = -docstring 'Prompt for bc' ': bc-prompt<ret>'
}

plug alexherbo2/palette.kak

plug occivink/kakoune-vertical-selection
plug Delapouite/kakoune-text-objects
plug 'https://gitlab.com/FlyingWombat/case.kak' config %{
	map global user '`' ': enter-user-mode case<ret>' -docstring "Case manipulation..."
}
plug 'delapouite/kakoune-hump' %{
  # Suggested mappings
  map global normal æ ': select-previous-hump<ret>' -docstring 'select prev hump'
  map global normal ø ': select-next-hump<ret>'     -docstring 'select next hump'
  map global normal Æ ': extend-previous-hump<ret>' -docstring 'extend prev hump'
  map global normal Ø ': extend-next-hump<ret>'     -docstring 'extend next hump'
}

plug 'https://gitlab.com/Screwtapello/kakoune-inc-dec' config %{
  map global normal + ': inc-dec-modify-numbers + %val{count}<ret>'
  map global normal <minus> ': inc-dec-modify-numbers - %val{count}<ret>'
}

#################################################
# CONFIGURATION
#################################################

unalias global e edit
alias global e edit-or-dir
# Keymaps

# Move macros to ¨
map global normal ¨ q
map global normal <a-¨> Q

map-all normal %{
    '#' comment-line "Comment line"
    '<a-#>' comment-block "Comment line"
}

def file-delete -docstring \
"Delete current file" %{
    nop %sh{ rm $kak_buffile }
   delete-buffer
}

new-mode files f %{
    f "fzf-file"                               "List files"
    t "lf"                                     "File tree (current file)"
    T "lf ."                                   "File tree (current dir)"
    w "write"                                  "Write file" 
    c "fzf-file ~/.config/kak/"                "Open config dir"
    d "file-delete"                            "Delete current file"
}

new-mode buffers b %{
    b fzf-buffer      "List Buffers" 
    n buffer-next     "Next Buffer" 
    p buffer-previous "Prev buffer" 
    d delete-buffer   "Delete buffer"
    u 'buffer *debug*' "Debug buffer"
}

def tmux-new-vertical -params .. -command-completion %{
  tmux-terminal-vertical kak -c %val{session} -e "%arg{@}"
}

def tmux-new-horizontal -params .. -command-completion %{
  tmux-terminal-horizontal kak -c %val{session} -e "%arg{@}"
}

new-mode tmux w %{
    h     'tmux select-pane -L' 'Select pane to the left'  -sh
    j     'tmux select-pane -D' 'Select pane below'        -sh
    k     'tmux select-pane -U' 'Select pane above'        -sh
    l     'tmux select-pane -R' 'Select pane to the right' -sh

    <tab> 'tmux last-pane'      'Select last pane'         -sh
    J     'tmux swap-pane -D'   'Swap pane below'          -sh
    K     'tmux swap-pane -U'   'Swap pane above'          -sh

    s     'tmux-new-vertical'   'Split horizontally'
    v     'tmux-new-horizontal' 'Split vertically'
    d     quit                  'Delete pane'
}

def git-blame-toggle %{
    try %[
        addhl window/git-blame flag_lines Info git_blame_flags
        rmhl window/git-blame
        git blame
    ] catch %[
        git hide-blame
    ]
}

new-mode git g %{
    g     'repl tig'            'Open tig'
    f     'fzf-git'             'Open files in repo'
    p     ':git '               'Open git prompt' -raw
    b     'git-blame-toggle'    'Toggle git blame'
}

# switch windows
map-all user -sh %{
    1 'tmux-select-pane 1'  'Select pane 1'
    2 'tmux-select-pane 2'  'Select pane 2'
    3 'tmux-select-pane 3'  'Select pane 3'
    4 'tmux-select-pane 4'  'Select pane 4'
    5 'tmux-select-pane 5'  'Select pane 5'
    6 'tmux-select-pane 6'  'Select pane 6'
    7 'tmux-select-pane 7'  'Select pane 7'
    8 'tmux-select-pane 8'  'Select pane 8'
    9 'tmux-select-pane 9'  'Select pane 9'
    0 'tmux-select-pane 10' 'Select pane 10'
}

decl str local_config_dir

def source-local-config -override -params ..1 %{
  eval %sh{
      function upsearch () {
          if test / == "$PWD"; then
              return
          elif test -e "$1"; then
              echo "set buffer local_config_dir $PWD"
              echo "source $PWD/$1"
              return
          else
              cd ..
              upsearch "$1"
          fi
      }

      startdir=${1:-$(dirname $kak_buffile)}
      [[ -d "$startdir" ]] && cd $startdir
      upsearch ".local.kak"
  }
}

hook global BufCreate .* source-local-config 
hook global BufCreate .* modeline-parse

# Autoload manually

declare-option str-list autoload_ignore core/php extra/modeline

# Filetypes

# Load current terminal colorscheme
colorscheme %sh{ colorscheme-switch --current }

import modeline
import markdown
import php
import c++
import js
import meson
import faust

import ide
ide-setup

colorscheme %sh{ colorscheme-switch --current }

#hook global KakBegin .* runtime
