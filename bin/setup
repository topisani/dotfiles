#!/bin/bash

# Use same toolsdir inside distrobox with its own home dir
TOOLSDIR=~/git/tools

setup::project() {
    cd $TOOLSDIR
    repo=$1
    name=${repo##*/}
    if ! [ -d "$name" ]; then
        git clone "$repo"
    else
        cd "$name"
        git pull
    fi
    cd "$TOOLSDIR/$name"
}

setup::fedora() {
    # Add terra repository (https://terra.fyralabs.com/)
    sudo dnf install --nogpgcheck --repofrompath 'terra,https://repos.fyralabs.com/terra$releasever' terra-release

    packages=(
        zsh
        zoxide
        diff-so-fancy
        bat
        ripgrep
        fd-find
        git-revise
        git-autofixup
        qalculate
        bc
        editorconfig
        tig
        fzf
        atuin
        eza
        eza-zsh-completion
        # GUI tools/utilities
        ghostty-shell-integration
        jetbrainsmono-nerd-fonts
        waybar
        rofi
        wofi
        dunstify
        udiskie
        mako
        network-manager-applet
        # GUI Applications
        ghostty
        zathura
        zathura-pdf-mupdf
        zathura-zsh-completion
        # imv
        nautilus
        python3-nautilus-open-any-terminal
        openssl-devel
        just
    )

    sudo dnf install ${packages[@]}

    # NIRI
    sudo dnf copr enable yalter/niri-git
    echo "priority=1" | sudo tee -a /etc/yum.repos.d/_copr:copr.fedorainfracloud.org:yalter:niri-git.repo
    sudo dnf install niri

    systemctl --user add-wants niri.service battery-notifyd.service
    systemctl --user add-wants niri.service swayidle.service
    systemctl --user add-wants niri.service swaybg.service
    systemctl --user add-wants niri.service udiskie.service
    systemctl --user add-wants niri.service waybar.service
    systemctl --user add-wants niri.service xsettingsd.service

    # RUST

    sudo dnf install rustup
    which rustup &> /dev/null || rustup-init

    cargo install cargo-binstall
    cargo binstall cargo-update
    cargo install-update -a

    # jj
    cargo binstall --strategies crate-meta-data jj-cli

    sudo dnf install yazi

    sudo dnf builddep tmux
    sudo dnf builddep kakoune
}

setup::gui() {
    gsettings set org.cinnamon.desktop.default-applications.terminal exec "ghostty"
    gsettings set org.cinnamon.desktop.default-applications.terminal exec-arg "-e"
    gsettings set org.gnome.desktop.default-applications.terminal exec "ghostty"
    gsettings set org.gnome.desktop.default-applications.terminal exec-arg "-e"
    gsettings set com.github.stunkymonkey.nautilus-open-any-terminal terminal "ghostty"
    # gsettings set com.github.stunkymonkey.nautilus-open-any-terminal custom-local-command "$(which tmux-term)"
    gsettings set com.github.stunkymonkey.nautilus-open-any-terminal keybindings '<Ctrl><Alt>t'
}

setup::arch() {
    paru -S --needed git zsh jq zoxide eza jujutsu
    paru -S --needed diff-so-fancy bat ripgrep fd git-revise git-autofixup libqalculate bc
    paru -S --needed editorconfig-core-c tig fzf yazi
}

setup::tools() {
    mkdir -p $TOOLSDIR

    # Kakoune and tools
    setup::project https://github.com/topisani/kakoune && (
        make
        sudo make install
    )

    setup::project https://github.com/topisani/kakoune-remote-control && (
        make install
    )

    # setup::project https://github.com/topisani/kak-lsp && (
    #     cargo install --path . --locked
    # )
    cargo install kak-lsp
    # cargo install sidetree

    setup::project https://github.com/topisani/kak-tree-sitter && (
        # git remote add upstream git@git.sr.ht:~hadronized/kak-tree-sitter
        # git fetch upstream
        # git reset --hard upstream/master
        cargo install --locked --path kak-tree-sitter
        cargo install --locked --path ktsctl
        ktsctl sync -a 
    )

    setup::project https://github.com/topisani/sidetree && (
        cargo install --path . --locked
    )

    setup::project https://github.com/topisani/tmux && (
        ./autogen.sh
        ./configure --enable-sixel
        make
        sudo make install
    )

    ya pkg install
}

setup::all() {
    if distro -j | jq -e '.id == "fedora"' &> /dev/null; then
        setup::fedora
        setup::gui
    elif distro -j | jq -e '.id == "arch"' &> /dev/null; then
        setup::arch
    fi
    setup::tools
}

[[ $# < 1 ]] && set -- all

setup::"$@"
