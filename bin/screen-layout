#! /bin/bash

_layout_office() {
  echo "'Dell Inc. DELL U2719D 7NRBS83' 0 0 90"
  echo "'Dell Inc. DELL U2719D CNRBS83' 1440 0"
  echo "eDP-1 1440 1440"
}

_layout_office_dual_vert() {
  echo "'Dell Inc. DELL U2719D 7NRBS83' 1920 0 270"
  echo "'Dell Inc. DELL U2719D CNRBS83' 3360 0 90"
  echo "'Dell Inc. DELL U2719D 5NRBS83' 4800 0 90"
  echo "eDP-1 0 840"
}

_layout_cpi() {
  echo "'Dell Inc. DELL U2412M 0FFXD45N5R8S' 0 0"
  echo "'Dell Inc. DELL 2405FPW M675459U1TTS ' 1920 0"
  echo "eDP-1 0 1200"
}

_layout_single() {
  echo "eDP-1 0 0"
}

_layout_home() {
  echo "'Philips Consumer Electronics Company Philips FTV 0x00000101' 0 0"
  echo "eDP-1 960 2160"
}

_select_auto_layout() {
  serials=$(swaymsg -t get_outputs | jq '.[].serial')
  if echo "$serials" | grep 7NRBS83 -q; then
    echo office_dual_vert
  elif echo "$serials" | grep 0FFXD45N5R8S -q; then
    echo cpi
  elif echo "$serials" | grep 0x00000101 -q; then
    echo home
  else
    echo single
  fi
}

_layout_auto() {
  "_layout_$(_select_auto_layout)"
}

_apply_sway() {
  swaymsg "output '*' enable"
  lid=$(cat /proc/acpi/button/lid/*/state)
  "_layout_$1" | while IFS="" read line; do
    declare -a "arr=($line)"
    name=${arr[0]}
    x=${arr[1]}
    y=${arr[2]}
    trans=${arr[3]:-normal}
    if [[ "$lid" =~ "closed" ]] && [[ "$name" =~ "eDP-1" ]]; then
      x="off"
    fi
    if [[ "$x" == "off" ]]; then
      swaymsg "output '$name' disable"
    else
      swaymsg "output '$name' enable pos $x $y transform $trans"
    fi
  done
}

_daemon() {
  layout=""
  while true; do
    new_layout=$(_select_auto_layout)
    if [[ "$layout" != "$new_layout" ]]; then
      layout="$new_layout"
      _apply_sway "$layout"
    fi
    sleep 10
  done
}

# Run

method=sway
layout=${1:-auto}

if [[ " $@ " =~ " -d " ]]; then
  _daemon
else
  "_apply_$method" $layout
fi
